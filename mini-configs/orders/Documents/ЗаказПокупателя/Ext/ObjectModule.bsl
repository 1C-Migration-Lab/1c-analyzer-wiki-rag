Процедура ОбработкаПроведения(Отказ, Режим)
	// Проверка заполнения шапки документа
	Если НЕ ЗначениеЗаполнено(Контрагент) Тогда
		Отказ = Истина;
		Сообщить("Не указан контрагент!");
		Возврат;
	КонецЕсли;
	
	// Проверка табличной части
	Если Товары.Количество() = 0 Тогда
		Отказ = Истина;
		Сообщить("Документ не содержит товаров!");
		Возврат;
	КонецЕсли;
	
	// Проверка количества и цен
	Для Каждого ТекСтрока Из Товары Цикл
		Если ТекСтрока.Количество <= 0 Тогда
			Отказ = Истина;
			Сообщить("В строке " + ТекСтрока.НомерСтроки + " указано некорректное количество!");
			Возврат;
		КонецЕсли;
		
		Если ТекСтрока.Цена < 0 Тогда
			Отказ = Истина;
			Сообщить("В строке " + ТекСтрока.НомерСтроки + " указана отрицательная цена!");
			Возврат;
		КонецЕсли;
	КонецЦикла;
	
	// Формирование движений по регистрам
	Если НЕ Отказ Тогда
		ДвиженияПоЗаказам.Записывать = Истина;
		
		Для Каждого ТекСтрока Из Товары Цикл
			Движение = ДвиженияПоЗаказам.Добавить();
			Движение.Период = Дата;
			Движение.Товар = ТекСтрока.Товар;
			Движение.Количество = ТекСтрока.Количество;
			Движение.Сумма = ТекСтрока.Сумма;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	// Пересчет сумм
	СуммаДокумента = 0;
	
	Для Каждого ТекСтрока Из Товары Цикл
		ТекСтрока.Сумма = ТекСтрока.Количество * ТекСтрока.Цена;
		СуммаДокумента = СуммаДокумента + ТекСтрока.Сумма;
	КонецЦикла;
КонецПроцедуры
